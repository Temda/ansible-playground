---
# Delete ALB infrastructure in reverse order

- name: Delete Application Load Balancer
  amazon.aws.elb_application_lb:
    name: "{{ alb_name }}"
    region: "{{ aws_region }}"
    state: absent
    wait: true
  register: result_alb

- name: Display ALB deletion result
  ansible.builtin.debug:
    msg: "ALB '{{ alb_name }}' has been deleted"

- name: Delete Target Group
  community.aws.elb_target_group:
    name: "{{ target_group_name }}"
    region: "{{ aws_region }}"
    state: absent
  register: result_target_group
  failed_when: false
  ignore_errors: true

- name: Display Target Group deletion result
  ansible.builtin.debug:
    msg: "{{ 'Target Group deleted' if result_target_group is succeeded else 'Target Group deletion skipped (not found or already deleted)' }}"

- name: Wait for ALB network interfaces to be cleaned up
  amazon.aws.ec2_security_group:
    name: "{{ alb_security_group_name }}"
    region: "{{ aws_region }}"
    state: absent
  register: result_alb_sg
  retries: 5
  delay: 15
  until: result_alb_sg is succeeded
  ignore_errors: true

- name: Display ALB Security Group deletion result
  ansible.builtin.debug:
    msg: "{{ 'ALB Security Group deleted' if result_alb_sg is succeeded else 'Security Group deletion skipped (may have dependencies)' }}"
